FILL_IN_FORM_PROMPT = """
我将给你一段医生诊断报告经过OCR提取之后的文本。基于以下文本，判断是否在报告中提及了以下关键信息。如果提及了，请从文本中总结或提取出以下内容并返回给我，如果没有提及，请返回NO给我
**医疗诊断报告：**
{ocr_text}
**关键信息/指标：**
{key_info}
**返回格式：**
{{
"key_1": "value_1",
"key_2": "value_2",
...
}}
**返回示例：**
假设我有如下关键信息需要提取：
[LM, LAD]
并且报告中包含了如下信息：
“左主干(LM) 管壁见钙化斑块，管腔轻度狭窄。左前降支(LAD)见近中段钙化斑块，局部管腔重度狹窄；”
那么我可能会返回：
{{
"LM": "管壁见钙化斑块",
"LAD": "近中段钙化斑块，局部管腔重度狹窄"
}}
**输出：**
"""


FILLIN_PROMPT_2 = """
我将给你一段医生诊断报告经过OCR提取之后的文本。基于以下文本，判断该患者的“冠状动脉起源、走形及终止”是正常还是异常。请回复正常或者异常，并简要给出理由。
**医疗诊断报告：**
{ocr_text}
**返回格式：**
{{
"key_name": "冠状动脉起源、走形及终止", # 固定
"result": "value_1",    # 正常或者异常
"reason": "value_2"    # 理由
}}
**返回示例：**
{{
"key_name": "冠状动脉起源、走形及终止",
"result": "正常",
"reason": "替换成你认为的根据报告产生的合适的理由"
}}
**输出：**
"""


FILLIN_PROMPT_3 = """
我将给你一段医生诊断报告经过OCR提取之后的文本。基于以下文本，判断该患者的属于“右冠优势型”， “左冠优势型”， 还是“均衡型”。请回复判断结果，并简要给出理由。请返回标准JSON格式。
**医疗诊断报告：**
{ocr_text}
**返回格式：**
{{
"key_name": "冠脉优势型",  # 固定
"result": "value_1",    # “右冠优势型”， “左冠优势型”， 还是“均衡型”
"reason": "value_2"    # 理由
}}
**返回示例：**
{{
"key_name": "冠脉优势型",
"result": "右冠优势型",
"reason": "替换成你认为的根据报告产生的合适的理由"
}}
**输出：**
"""


FILLIN_PROMPT_4 = """
我将给你一段医生诊断报告经过OCR提取之后的文本。基于以下文本，提取“异常描述”。如果没有任何异常描述，请返回“NO”给我。请返回标准JSON格式。
**医疗诊断报告：**
{ocr_text}
**返回格式：**
{{
"key_name": "异常描述",  # 固定
"result": "value_1",    # 异常描述
}}
**输出：**
"""


FILLIN_PROMPT_5 = """
我将给你一段医生诊断报告经过OCR提取之后的文本。请你基于以下文本，提取冠脉节段"{location}(名称)"的以下字段信息：
- 斑块种类
- 类型
- 症状
- 数值
- 狭窄程度
- 闭塞

如果相应字段没有提及，请返回"-"（或"否"等合适的默认值）。

**字段说明：**
- "闭塞"字段请返回"是"或者"否"；
- "斑块种类"可选：软斑块（非钙化性斑块）、混合密度斑块、硬斑块（钙化性斑块）；
- "狭窄程度"可选：局限性狭窄（长度＜10mm）、阶段性狭窄（10-20mm）、弥漫性狭窄（＞20mm）；
- 其余字段如未提及请填写"-"。

**医疗诊断报告：**
{ocr_text}

**返回格式：**
{{
"斑块种类": "value_斑块种类",
"类型": "value_类型",
"症状": "value_症状",
"数值": "value_数值",
"狭窄程度": "value_狭窄程度",
"闭塞": "value_闭塞"
}}

**只返回JSON，不要输出其他内容。**
"""


REPORT_CLASSIFIER_PROMPT = """
我将给你一段医疗报告经过OCR提取之后的文本。请你判断这份报告主要是关于什么类型的检查。

请仔细阅读报告内容，然后判断它是：
1. **冠脉CTA报告** - 主要描述冠状动脉血管结构、斑块、狭窄程度等
2. **心脏超声报告** - 主要描述心脏腔室尺寸、心功能、血流速度等生理功能指标

**医疗诊断报告：**
{ocr_text}

**判断依据：**
- 如果报告中主要包含"左主干"、"前降支"、"回旋支"、"右冠"、"斑块"、"狭窄"、"钙化"等词汇，则为冠脉CTA报告
- 如果报告中主要包含"射血分数"、"舒张期"、"收缩期"、"房室腔"、"瓣膜"、"血流速度"、"多普勒"等词汇，则为心脏超声报告

**返回格式：**
{{
"report_type": "CTA",    # 只能是 "CTA" 或 "Ultrasound"
"confidence": "高",      # 置信度：高/中/低
"reason": "判断理由"     # 简要说明判断依据
}}

**只返回JSON，不要输出其他内容。**
"""


ULTRASOUND_EXTRACT_PROMPT = """
我将给你一段心脏超声诊断报告经过OCR提取之后的文本。请你基于以下文本，**仅为超声测量项目"{location}"**提取以下字段信息：
- 斑块种类
- 类型  
- 症状
- 数值
- 狭窄程度
- 闭塞

**重要说明：**
- 请**严格按照给定的项目名称"{location}"进行精确匹配**
- 只提取与"{location}"完全对应的数值，不要提取其他相似项目的数值
- 对于超声心动图测量项目，只有"数值"和"闭塞"字段有意义
- "斑块种类"、"类型"、"症状"、"狭窄程度" 字段对超声测量不适用，请始终返回 "-"
- "数值"字段：提取具体的测量数值（仅数字部分，不包含单位）
- "闭塞"字段：对于血管相关测量返回"是"或"否"，其他测量返回"否"

**严格要求：**
- 如果报告中没有提到项目名称"{location}"的确切信息，请在"数值"字段返回"-"
- 不要使用任何别名或相似词汇进行匹配
- 不要将其他项目的数值错误分配给当前项目

{dynamic_alias_rules}

**医疗诊断报告：**
{ocr_text}

**返回格式：**
{{
"斑块种类": "-",
"类型": "-", 
"症状": "-",
"数值": "实际测量数值或-",
"狭窄程度": "-",
"闭塞": "否"
}}

**只返回JSON，不要输出其他内容。**
"""

# 新增：超声头部信息抽取（严格缺失留空）
ULTRASOUND_HEADER_PROMPT = """
你是一名超声报告抽取助手。请从以下OCR文本中，仅提取心脏超声报告的头部信息。严格遵守：若某字段在文本中未明确给出，返回空字符串。不要推测或补全。

需要抽取并返回的字段键名（必须完全一致）：
- 姓名
- 性别
- 年龄
- 超声号
- 门诊号
- 住院号
- 床号
- 检查设备
- 检查部位
- 探头频率
- 图像质量
- 超声所见
- 超声提示

注意：
- 年龄直接返回文本中出现的字符串形式（例如"28岁"），不要计算。
- 探头频率如出现单位（如 MHz）可以保留原样。
- "超声所见"与"超声提示"通常是段落或多行内容，请截取对应标题下的全部文本，直到下一个大标题或文本结束。
- 如果没有明确的标题，请根据常见格式定位（例如“超声所见:”、“所见：”、“超声提示:”、“提示：”）。

OCR文本：
-----
{ocr_text}
-----
仅返回一个严格的JSON对象，键为上述字段名，值为字符串（没有则为空字符串）：
"""

# 新增：从全文提取全部“测量项目 → 数值(可含单位)”的字典
ULTRASOUND_ALL_MEASUREMENTS_PROMPT = """
请从以下心脏超声报告文本中，抽取所有"测量项目 → 数值"的映射，尽量保留紧随数值后的单位（若有）。

严格要求：
- 只返回 JSON 对象，键是测量项目名称（原文或报告常用写法），值是字符串形式的数值（可包含单位，如 "18mmHg" 或 "59%"）。
- 不要推测不存在的项目；找不到就不要返回该键。
- 不要汇总或改写名称，保留原文或常用写法，以便后续标准化。

心脏超声OCR文本：
-----
{ocr_text}
-----
仅返回 JSON 对象：
"""

# 新增：精确抽取关键测量值（未找到留空）
ULTRASOUND_KEY_METRICS_PROMPT = """
从以下心脏超声报告文本中，严格抽取下列关键测量值。只在文本中出现明确数值时填写；未出现则返回空字符串。不要推测，不要换单位。

需要返回的键（键名必须完全一致）：
- LVEF           # 左心室射血分数，期望形式如 "59%"
- LVEDD          # 左室舒张末内径，期望如 "42mm"
- LVESD          # 左室收缩末内径，期望如 "29mm"
- IVSd           # 室间隔舒张期厚度，期望如 "8mm"
- LVPWd          # 左室后壁舒张期厚度，期望如 "8mm"
- E/A            # 二尖瓣E峰/A峰比值，期望如 "0.9" 或 "E/A<1"
- e′             # 二尖瓣环e′速度，期望如 "7.9 cm/s"
- a′             # 二尖瓣环a′速度，期望如 "<1 cm/s" 或 "1.2 cm/s"
- 异常描述        # 若有总结性异常描述，返回其内容；否则空字符串

心脏超声OCR文本：
-----
{ocr_text}
-----
请仅返回一个JSON对象，例如：
{
  "LVEF": "59%",
  "LVEDD": "42mm",
  "LVESD": "29mm",
  "IVSd": "8mm",
  "LVPWd": "8mm",
  "E/A": "0.9",
  "e′": "7.9 cm/s",
  "a′": "<1 cm/s",
  "异常描述": "..."
}
未出现的键请返回空字符串。不要返回任何多余文字。
"""

# 别名/同义校验：给定 query 与候选，要求只从候选中选一个 exact_name 或返回 no_match
ALIAS_VALIDATION_PROMPT = """
你是医学术语规范化助手。请判断 query 是否与 candidates 中的某一项表示同一测量项目（可能是变体、简称、同义写法）。
严格要求：
- 只有在把握充分时，才从 candidates 里选出一个 exact_name；否则返回 "no_match"
- 只能返回 candidates 中的一个 exact_name，或 "no_match"

输入：
query：{query}
候选（JSON）：
{candidates_json}

仅返回严格 JSON，例如 {{"match":"左心室射血分数"}} 或 {{"match":"no_match"}}。不要返回多余文字。
"""

# 从最终输出表格中回填关键指标：给表格JSON与同义词映射，请仅在表内查找并返回数值（可附单位），未找到留空
ULTRASOUND_KEYS_FROM_TABLE_PROMPT = """
你将获得一张“已经整理好的心脏超声输出表格”的JSON表示（数组，每项是一行，字段包含：名称、英文、数值、单位）。
请仅在这张表内查找以下目标键的对应值，并返回严格JSON。不要推测，不要从表外获取信息。
若在表中找不到，返回空字符串。

目标键（键名必须完全一致）：
- LVEF
- LVEDD
- LVESD
- IVSd
- LVPWd
- E/A
- e′
- E/e′
- a′

常见同义/别名映射（JSON）：
{synonyms_json}

表格JSON：
-----
{table_json}
-----

匹配规则：
- 允许基于“名称/英文/括号中的简写/常见别名”进行匹配，例如“左心室射血分数(LVEF)”可匹配到 LVEF/EF/射血分数。
- 仅返回表中已有的“数值+单位（若单位存在）”组合，不做单位换算。
- 若一个目标键能匹配到多行，请选择最直接的行（语义最贴近的标准名/简写所在行）。

仅返回一个严格的JSON对象，例如：
{{"LVEF":"59%","LVEDD":"42mm", ...}}。
不要返回除JSON以外的任何文字。
"""

# 将关键指标键映射到表格“名称”候选，由 LLM 判定是否为同义/别名关系
ULTRASOUND_KEY_NAME_MATCH_PROMPT = """
你将获得两个列表：
- target_keys: 需要回填到GUI顶部的关键指标键名列表（例如 ["LVEF","LVEDD",...]）。
- candidate_names: 已整理好的输出表格中“名称”列的候选名称列表。

任务：请逐一判断每个 target_key 是否能在 candidate_names 中找到最合适的对应名称（可能是中文、英文、缩写或别名关系）。
严格要求：
- 只能从 candidate_names 中选择；若无匹配或不确定，请返回空字符串。
- 仅依据常识与医学常用写法进行别名/同义判断，不要创造新名称。
- 仅返回一个严格的 JSON 对象：键为每个 target_key，值为匹配到的 candidate_name 或空字符串。

示例输出：
{{"LVEF":"左心室射血分数(LVEF)","LVEDD":"左室舒张末内径","LVESD":"","IVSd":"室间隔舒张期厚度"}}

输入：
- target_keys (JSON): {target_keys_json}
- candidate_names (JSON): {candidate_names_json}
"""

# 单键匹配：给出一个 target_key 与候选名称列表，请只从候选中选出与 target_key 同义/全称/常用写法最一致的一个名称；不确定则返回空字符串。
ULTRASOUND_KEY_NAME_PICK_PROMPT = """
你是医学术语匹配助手。请判断 target_key 的规范含义（全称/中文），并在 candidate_names 列表中找出与其同义/等价的一个名称。
严格要求：
- 只能从 candidate_names 中选择并原样返回；若无合适项或不确定，返回空字符串。
- 不要创造新名称；不要修改候选名称中的任何字符。
- 仅返回严格 JSON：{{"match": "候选中的某一项或空字符串"}}，不要输出其他文字。

输入：
- target_key: {target_key}
- candidate_names (JSON): {candidate_names_json}
"""
